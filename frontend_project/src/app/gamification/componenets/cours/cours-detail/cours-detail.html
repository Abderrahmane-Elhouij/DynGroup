@if (loading()) {
<div class="card">
    <p-skeleton height="3rem" class="mb-4" />
    <p-skeleton height="6rem" class="mb-4" />
    <p-skeleton height="20rem" />
</div>
} @else if (course()) {
<div class="card mb-8">
    <div class="flex flex-col lg:flex-row lg:items-start gap-8">
        <div class="flex items-center justify-center bg-primary/10 rounded-2xl" style="min-width: 12rem; height: 12rem">
            <i class="pi pi-book text-primary text-6xl"></i>
        </div>
        <div class="flex-1">
            <div class="flex items-center gap-3 mb-3">
                <h1 class="text-3xl font-bold text-surface-900 dark:text-surface-0 m-0">{{ course()!.titre }}</h1>
                <p-tag [value]="getDifficultyLabel(course()!.difficulte)" [severity]="getDifficultyColor(course()!.difficulte)" />
            </div>
            <p class="text-surface-600 dark:text-surface-300 text-lg mb-6 m-0">{{ course()!.description }}</p>
            <div class="flex flex-wrap items-center gap-6 mb-6">
                <span class="flex items-center gap-2 text-surface-500 dark:text-surface-400"> <i class="pi pi-clock"></i> {{ course()!.dureeEstimee }}h estimees </span>
                <span class="flex items-center gap-2 text-surface-500 dark:text-surface-400"> <i class="pi pi-folder"></i> {{ course()!.chapitres.length }} chapitres </span>
                <span class="flex items-center gap-2 text-surface-500 dark:text-surface-400"> <i class="pi pi-file"></i> {{ totalLecons() }} lecons </span>
            </div>

            @if (course()!.inscrit) {
            <div class="mb-4">
                <div class="flex justify-between text-sm mb-2">
                    <span class="text-surface-500 dark:text-surface-400">Progression globale</span>
                    <span class="font-bold text-primary">{{ course()!.progression }}%</span>
                </div>
                <p-progressBar [value]="course()!.progression" [showValue]="false" styleClass="h-3" />
            </div>
            } @else {
            <p-button label="S'inscrire a ce cours" icon="pi pi-plus" (onClick)="enroll()" [loading]="enrolling()" severity="success" size="large" />
            }
        </div>
    </div>
</div>

@if (enrollMessage()) {
<p-message [severity]="'success'" [text]="enrollMessage()!" class="mb-6 block" />
}

<div class="card">
    <h2 class="text-xl font-bold text-surface-900 dark:text-surface-0 mb-6 m-0">Contenu du cours</h2>
    <p-accordion [multiple]="true">
        @for (chapitre of course()!.chapitres; track chapitre.id; let i = $index) {
        <p-accordion-panel [value]="'panel_' + i">
            <p-accordion-header>
                <div class="flex items-center gap-3 w-full">
                    <span class="font-semibold">{{ chapitre.titre }}</span>
                    <p-badge [value]="chapitre.lecons.length + ''" severity="secondary" />
                </div>
            </p-accordion-header>
            <p-accordion-content>
                <div class="flex flex-col gap-2">
                    @for (lecon of chapitre.lecons; track lecon.id) {
                    <div
                        class="flex items-center p-4 rounded-xl border border-surface-200 dark:border-surface-700 hover:bg-surface-50 dark:hover:bg-surface-800 transition-colors"
                        [class.cursor-pointer]="course()!.inscrit"
                        [routerLink]="course()!.inscrit ? ['/lecons', lecon.id] : null"
                    >
                        <div
                            class="flex items-center justify-center rounded-full mr-4"
                            style="width: 2.5rem; height: 2.5rem"
                            [class.bg-green-100]="lecon.statut === 'TERMINE'"
                            [class.dark:bg-green-900]="lecon.statut === 'TERMINE'"
                            [class.bg-surface-100]="lecon.statut !== 'TERMINE'"
                            [class.dark:bg-surface-800]="lecon.statut !== 'TERMINE'"
                        >
                            <i [class]="lecon.statut === 'TERMINE' ? 'pi pi-check-circle text-green-500' : 'pi pi-circle text-surface-400'" class="text-lg"></i>
                        </div>
                        <div class="flex-1">
                            <div class="font-medium text-surface-900 dark:text-surface-0">{{ lecon.titre }}</div>
                            <div class="text-surface-500 dark:text-surface-400 text-sm flex items-center gap-3 mt-1">
                                <span><i class="pi pi-tag mr-1"></i>{{ getTypeLabel(lecon.typeContenu) }}</span>
                                <span><i class="pi pi-star mr-1"></i>{{ lecon.xpReward }} XP</span>
                                @if (lecon.aQuiz) {
                                <span class="text-primary font-medium"><i class="pi pi-question-circle mr-1"></i>Quiz</span>
                                }
                            </div>
                        </div>
                        @if (course()!.inscrit) {
                        <i class="pi pi-chevron-right text-surface-400"></i>
                        }
                    </div>
                    }
                </div>
            </p-accordion-content>
        </p-accordion-panel>
        }
    </p-accordion>
</div>

    @if (course()!.inscrit && hasQuizzes()) {
        <div class="card mt-8">
            <h2 class="text-xl font-bold text-surface-900 dark:text-surface-0 mb-2 m-0">
                <i class="pi pi-question-circle mr-2 text-primary"></i>Quiz du cours
            </h2>
            <p class="text-surface-500 dark:text-surface-400 mb-6 m-0">Completez les lecons pour debloquer les quiz associes.</p>
            <div class="flex flex-col gap-4">
                @for (lecon of getQuizLessons(); track lecon.id) {
                    <div class="flex flex-col md:flex-row items-start md:items-center justify-between p-5 rounded-2xl border transition-colors"
                         [class.border-primary]="lecon.statut === 'TERMINE'"
                        [class.bg-primary]="lecon.statut === 'TERMINE'"
                        [class.dark:bg-primary]="lecon.statut === 'TERMINE'"
                        [class.border-surface-200]="lecon.statut !== 'TERMINE'"
                        [class.dark:border-surface-700]="lecon.statut !== 'TERMINE'"
                        [class.bg-surface-50]="lecon.statut !== 'TERMINE'"
                        [class.dark:bg-surface-800]="lecon.statut !== 'TERMINE'">
                    <div class="flex items-center gap-4">
                        <div class="flex items-center justify-center rounded-full" style="width: 3rem; height: 3rem"
                             [class.bg-primary]="lecon.statut === 'TERMINE'"
                        [class.bg-surface-200]="lecon.statut !== 'TERMINE'"
                        [class.dark:bg-surface-700]="lecon.statut !== 'TERMINE'">
                        <i [class]="lecon.statut === 'TERMINE' ? 'pi pi-question-circle text-primary text-xl' : 'pi pi-lock text-surface-400 text-xl'"></i>
                    </div>
                    <div>
                        <div class="font-semibold text-surface-900 dark:text-surface-0">Quiz - {{ lecon.titre }}</div>
                        <div class="text-surface-500 dark:text-surface-400 text-sm mt-1">
                            @if (lecon.statut === 'TERMINE') {
                                <span class="text-green-500"><i class="pi pi-check mr-1"></i>Lecon completee - Quiz disponible</span>
                            } @else {
                                <span><i class="pi pi-lock mr-1"></i>Completez d'abord la lecon "{{ lecon.titre }}"</span>
                            }
                        </div>
                    </div>
                    </div>
                    <div class="mt-3 md:mt-0">
                        @if (lecon.statut === 'TERMINE') {
                            <p-button label="Passer le quiz" icon="pi pi-play" [routerLink]="['/quiz', lecon.quizId]" />
                        } @else {
                            <p-button label="Quiz verrouille" icon="pi pi-lock" [disabled]="true" severity="secondary" />
                        }
                    </div>
                    </div>
                }
            </div>
        </div>
    }
}
